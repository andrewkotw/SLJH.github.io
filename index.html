<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’åºæ¼”ç®—æ³•å¯¦é©—å®¤ - é­”ç‹æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
        .boss-glow { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, className, size = 24 }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    const attrName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    i.setAttribute('data-lucide', attrName);
                    i.style.width = `${size}px`;
                    i.style.height = `${size}px`;
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons({
                        attrs: { 'stroke-width': 2, width: size, height: size },
                        nameAttr: 'data-lucide',
                        icons: window.lucide.icons
                    });
                }
            }, [name, size]);
            return <span ref={iconRef} className={`inline-flex items-center justify-center ${className}`} style={{ width: size, height: size }}></span>;
        };

        const App = () => {
            const [numbers, setNumbers] = useState([]);
            const [algorithm, setAlgorithm] = useState('bubble'); 
            const [step, setStep] = useState(0);
            const [subStep, setSubStep] = useState(0); 
            const [highlightIndices, setHighlightIndices] = useState([]);
            const [sortedIndices, setSortedIndices] = useState([]);
            const [message, setMessage] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [isComplete, setIsComplete] = useState(false);
            const [tempValue, setTempValue] = useState(null); 
            const [shakingIdx, setShakingIdx] = useState(null);
            
            // æ¨¡å¼ç‹€æ…‹
            const [isChallengeMode, setIsChallengeMode] = useState(false);
            const [isBossLevel, setIsBossLevel] = useState(false);
            const [isBossUnlocked, setIsBossUnlocked] = useState(() => {
                return localStorage.getItem('sorting_boss_unlocked') === 'true';
            });

            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [bestScores, setBestScores] = useState({ bubble: null, selection: null, insertion: null });
            const timerRef = useRef(null);

            const initGame = (forceBoss = false) => {
                const size = forceBoss ? 12 : 6;
                const min = 5;
                const max = forceBoss ? 80 : 50;
                
                let baseNums = Array.from({ length: size }, () => min + Math.floor(Math.random() * (max - min)));
                
                setNumbers(baseNums);
                setStep(0);
                setSubStep(0);
                setHighlightIndices([]);
                setSortedIndices([]);
                setIsComplete(false);
                setTempValue(null);
                setElapsedTime(0);
                setStartTime(null);
                setErrorMsg('');
                if (timerRef.current) clearInterval(timerRef.current);
                updateInstruction(algorithm, 0, 0, baseNums, [], null, true);
            };

            useEffect(() => { initGame(isBossLevel); }, [algorithm, isBossLevel]);

            const startTimer = () => {
                if (!startTime && isChallengeMode) {
                    const now = Date.now();
                    setStartTime(now);
                    timerRef.current = setInterval(() => {
                        setElapsedTime(Math.floor((Date.now() - now) / 1000));
                    }, 1000);
                }
            };

            const triggerError = (idx, msg) => {
                setShakingIdx(idx);
                setErrorMsg(msg);
                setTimeout(() => { setShakingIdx(null); setErrorMsg(''); }, 1000);
            };

            const updateInstruction = (algo, s, ss, currentNums, currentSorted, temp = null, isFirstStep = false) => {
                if (isChallengeMode && !isFirstStep) {
                    setMessage("ã€ç«¶è³½ä¸­ã€‘ï¼šè«‹æ†‘è¨˜æ†¶å®Œæˆï¼");
                    setHighlightIndices([]);
                    return;
                }
                const prefix = isBossLevel ? "ğŸ”¥ [é­”ç‹é—œ] " : "";
                if (algo === 'bubble') {
                    const limit = currentNums.length - 1 - currentSorted.length;
                    const j = s % limit;
                    setMessage(`${prefix}æ¯”è¼ƒä½ç½® ${j} èˆ‡ ${j + 1}ã€‚é»æ“Šè¼ƒå¤§çš„æ•¸å­—ã€‚`);
                    setHighlightIndices([j, j + 1]);
                } else if (algo === 'selection') {
                    const i = currentSorted.length;
                    if (ss === 0) {
                        setMessage(`${prefix}è«‹å…ˆé»æ“Šç›®æ¨™ä½ç½® ${i}ã€‚`);
                        setHighlightIndices([i]);
                    } else {
                        const minVal = Math.min(...currentNums.slice(i));
                        const minIdx = currentNums.indexOf(minVal, i);
                        setMessage(`${prefix}å°‹æ‰¾æœ€å°æ•¸ (${minVal})ã€‚`);
                        setHighlightIndices([i, minIdx]);
                    }
                } else if (algo === 'insertion') {
                    const i = currentSorted.length === 0 ? 1 : currentSorted.length;
                    if (temp === null) {
                        setMessage(`${prefix}æå–ä½ç½® ${i} çš„æ•¸å­— (${currentNums[i]})ã€‚`);
                        setHighlightIndices([i]);
                    } else {
                        setMessage(`${prefix}æ¯” ${temp} å¤§å‰‡å³ç§»ï¼Œå¦å‰‡æ”¾ä¸‹ã€‚`);
                    }
                }
            };

            const handleBlockClick = (index) => {
                if (isComplete || errorMsg) return;
                startTimer();
                if (algorithm === 'bubble') handleBubble(index);
                else if (algorithm === 'selection') handleSelection(index);
                else if (algorithm === 'insertion') handleInsertion(index);
            };

            const handleBubble = (index) => {
                const limit = numbers.length - 1 - sortedIndices.length;
                const j = step % limit;
                if (index !== j && index !== j + 1) return;
                const leftVal = numbers[j];
                const rightVal = numbers[j + 1];
                const maxVal = Math.max(leftVal, rightVal);
                if (numbers[index] !== maxVal) {
                    triggerError(index, "é †åºéŒ¯å›‰ï¼");
                    return;
                }
                const newNums = [...numbers];
                if (leftVal > rightVal) {
                    [newNums[j], newNums[j + 1]] = [newNums[j + 1], newNums[j]];
                    setNumbers(newNums);
                }
                const nextStep = step + 1;
                if (nextStep >= limit) {
                    const newSortedCount = sortedIndices.length + 1;
                    const newSorted = Array.from({length: newSortedCount}, (_, i) => numbers.length - 1 - i);
                    setSortedIndices(newSorted);
                    setStep(0);
                    if (newSorted.length === numbers.length - 1) {
                        finishLevel();
                    } else {
                        updateInstruction('bubble', 0, 0, newNums, newSorted, null, false);
                    }
                } else {
                    setStep(nextStep);
                    updateInstruction('bubble', nextStep, 0, newNums, sortedIndices, null, false);
                }
            };

            const handleSelection = (index) => {
                const i = sortedIndices.length;
                const minVal = Math.min(...numbers.slice(i));
                const minIdx = numbers.indexOf(minVal, i);
                if (subStep === 0) {
                    if (index === i) {
                        setSubStep(1);
                        updateInstruction('selection', 0, 1, numbers, sortedIndices, null, false);
                    } else { triggerError(index, `è«‹å…ˆé»æ“Š POS: ${i}`); }
                } else {
                    if (index === minIdx) {
                        const newNums = [...numbers];
                        [newNums[i], newNums[minIdx]] = [newNums[minIdx], newNums[i]];
                        setNumbers(newNums);
                        const newSorted = [...sortedIndices, i];
                        setSortedIndices(newSorted);
                        setSubStep(0);
                        if (newSorted.length >= numbers.length - 1) {
                            finishLevel();
                        } else { updateInstruction('selection', 0, 0, newNums, newSorted, null, false); }
                    } else { triggerError(index, "é€™ä¸æ˜¯æœ€å°çš„ã€‚"); }
                }
            };

            const handleInsertion = (index) => {
                const i = sortedIndices.length === 0 ? 1 : sortedIndices.length;
                if (tempValue === null) {
                    if (index === i) {
                        const val = numbers[i];
                        setTempValue(val);
                        const newNums = [...numbers];
                        newNums[i] = null;
                        setNumbers(newNums);
                        updateInstruction('insertion', 0, 1, newNums, sortedIndices, val, false);
                    } else { triggerError(index, `è«‹æ‹”å‡º POS: ${i}`); }
                } else {
                    const nullIdx = numbers.indexOf(null);
                    if (index === nullIdx - 1) {
                        if (numbers[index] > tempValue) {
                            const newNums = [...numbers];
                            newNums[nullIdx] = newNums[index];
                            newNums[index] = null;
                            setNumbers(newNums);
                            updateInstruction('insertion', 0, 1, newNums, sortedIndices, tempValue, false);
                        } else { triggerError(index, "å·¦å´æ•¸å€¼è¼ƒå°ï¼Œä¸èƒ½ç§»å‹•ã€‚"); }
                    } else if (index === nullIdx) {
                        if (nullIdx === 0 || numbers[nullIdx - 1] <= tempValue) {
                            const newNums = [...numbers];
                            newNums[nullIdx] = tempValue;
                            setNumbers(newNums);
                            setTempValue(null);
                            const nextSortedLen = i + 1;
                            const newSorted = Array.from({ length: nextSortedLen }, (_, k) => k);
                            setSortedIndices(newSorted);
                            if (nextSortedLen === numbers.length) {
                                finishLevel();
                            } else { updateInstruction('insertion', 0, 0, newNums, newSorted, null, false); }
                        } else { triggerError(index, "å·¦é‚Šé‚„æœ‰æ›´å¤§çš„æ•¸å€¼ï¼"); }
                    }
                }
            };

            const finishLevel = () => {
                setIsComplete(true);
                setSortedIndices(Array.from({length: numbers.length}, (_, i) => i));
                
                // è§£é–é­”ç‹é—œæ¢ä»¶ï¼šç«¶è³½æ¨¡å¼ + ä¸€èˆ¬é—œå¡
                if (isChallengeMode && !isBossLevel && !isBossUnlocked) {
                    setIsBossUnlocked(true);
                    localStorage.setItem('sorting_boss_unlocked', 'true');
                    setMessage(`ğŸ† æ­å–œï¼å®ŒæˆæŒ‘æˆ°ï¼Œè§£é–ã€é­”ç‹é—œå¡ã€‘ï¼è€—æ™‚ ${elapsedTime}s`);
                } else {
                    setMessage(`æ­å–œå®Œæˆï¼è€—æ™‚ ${elapsedTime}s`);
                }
            };

            const algorithms = [
                { id: 'bubble', name: 'æ°£æ³¡æ’åº' },
                { id: 'selection', name: 'é¸æ“‡æ’åº' },
                { id: 'insertion', name: 'æ’å…¥æ’åº' }
            ];

            return (
                <div className={`min-h-screen p-4 md:p-8 transition-all duration-700 ${isBossLevel ? 'bg-black text-red-50' : isChallengeMode ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
                    <div className="max-w-6xl mx-auto">
                        <header className="text-center mb-6">
                            <div className="flex items-center justify-center gap-3 mb-2">
                                <h1 className={`text-4xl font-black italic tracking-tighter ${isBossLevel ? 'text-red-600 uppercase animate-pulse' : 'text-indigo-700'}`}>
                                    {isBossLevel ? "é­”ç‹æŒ‘æˆ°ï¼šçµ‚æ¥µæ’åº" : "æ’åºæ¼”ç®—æ³•å¯¦é©—å®¤"}
                                </h1>
                                {isBossLevel ? <Icon name="Skull" className="text-red-600" size={32} /> : <Icon name="Zap" className="text-amber-400" />}
                            </div>
                            <p className="opacity-60">{isBossLevel ? "12 çµ„æ•¸æ“šçš„æ¥µé™è€ƒé©—..." : "æŒæ¡æ’åºæ¼”ç®—æ³•çš„å¥§ç§˜"}</p>
                        </header>

                        {/* æ¨¡å¼åˆ‡æ›èˆ‡è§£é–ç‹€æ…‹ */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <button 
                                onClick={() => { setIsChallengeMode(!isChallengeMode); initGame(isBossLevel); }}
                                className={`p-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg ${isChallengeMode ? 'bg-amber-500 text-black border-4 border-amber-300' : 'bg-slate-700 text-white'}`}
                            >
                                <Icon name={isChallengeMode ? "Timer" : "Gamepad2"} />
                                {isChallengeMode ? "ç«¶è³½æ¨¡å¼ï¼šé–‹å•Ÿ" : "åˆ‡æ›ç«¶è³½æ¨¡å¼"}
                            </button>

                            <button 
                                onClick={() => { 
                                    if (isBossUnlocked) {
                                        setIsBossLevel(!isBossLevel);
                                        initGame(!isBossLevel);
                                    }
                                }}
                                disabled={!isBossUnlocked}
                                className={`p-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg ${!isBossUnlocked ? 'opacity-40 cursor-not-allowed bg-slate-300 text-slate-500' : isBossLevel ? 'bg-red-600 text-white boss-glow' : 'bg-slate-800 text-red-400 border border-red-900'}`}
                            >
                                <Icon name={isBossUnlocked ? (isBossLevel ? "Sword" : "LockOpen") : "Lock"} />
                                {isBossUnlocked ? (isBossLevel ? "å›åˆ°ä¸€èˆ¬é—œå¡" : "é€²å…¥é­”ç‹é—œå¡ (12çµ„)") : "é­”ç‹é—œ (éœ€ç«¶è³½ç ´é—œè§£é–)"}
                            </button>

                            <div className={`p-4 rounded-2xl border flex items-center justify-between px-6 ${isBossLevel ? 'bg-red-900/20 border-red-700' : 'bg-white border-slate-200'}`}>
                                <div className="text-sm font-bold opacity-50 uppercase">ç•¶å‰æ™‚é–“</div>
                                <div className={`text-2xl font-mono font-black ${isBossLevel ? 'text-red-500' : 'text-indigo-600'}`}>{elapsedTime}s</div>
                            </div>
                        </div>

                        {/* æ¼”ç®—æ³•é¸æ“‡ */}
                        <div className="flex flex-wrap justify-center gap-3 mb-8">
                            {algorithms.map((a) => (
                                <button key={a.id} onClick={() => setAlgorithm(a.id)} className={`px-6 py-2 rounded-full text-sm font-black transition-all ${algorithm === a.id ? (isBossLevel ? 'bg-red-600 text-white scale-110' : 'bg-indigo-600 text-white scale-110 shadow-lg') : (isBossLevel ? 'bg-slate-800 text-red-900' : 'bg-slate-200 text-slate-500')}`}>
                                    {a.name}
                                </button>
                            ))}
                        </div>

                        {/* ä¸»è¦éŠæˆ²å€å¡Š */}
                        <div className={`rounded-3xl shadow-2xl p-4 md:p-8 mb-8 border-b-8 transition-all duration-500 ${isBossLevel ? 'bg-zinc-950 border-red-700 shadow-red-900/20' : 'bg-white border-indigo-200'}`}>
                            <div className={`flex items-center gap-3 p-4 mb-10 rounded-xl transition-all ${errorMsg ? 'bg-red-600 text-white animate-shake' : isBossLevel ? 'bg-red-950/50 text-red-400 border border-red-800' : 'bg-indigo-50 text-indigo-900'}`}>
                                <Icon name={errorMsg ? "Skull" : "Zap"} size={20} />
                                <p className="font-bold text-sm md:text-base">{errorMsg || message}</p>
                            </div>

                            {/* æ•¸å€¼è¦–è¦ºåŒ– - é‡å°12çµ„æ•¸æ“šå„ªåŒ– */}
                            <div className="flex flex-col items-center gap-10">
                                <div className="w-full overflow-x-auto pb-4">
                                    <div className={`flex gap-1 md:gap-3 items-end justify-center min-w-max px-4 h-64`}>
                                        {numbers.map((num, idx) => (
                                            <div key={idx} className={`flex flex-col items-center gap-2 transition-all duration-300 ${shakingIdx === idx ? 'animate-shake' : ''}`}>
                                                {/* é•·æ¢åœ– */}
                                                <div 
                                                    className={`w-6 md:w-12 rounded-t-md transition-all duration-500 ${num === null ? 'h-0 opacity-0' : 'opacity-100'} ${highlightIndices.includes(idx) ? (isBossLevel ? 'bg-red-500' : 'bg-yellow-400 shadow-lg shadow-yellow-400/50') : sortedIndices.includes(idx) ? 'bg-green-500' : (isBossLevel ? 'bg-zinc-800' : 'bg-slate-300')}`} 
                                                    style={{ height: num ? `${num * (isBossLevel ? 2 : 3)}px` : '0px' }} 
                                                />
                                                {/* æ–¹å¡ŠæŒ‰éˆ• */}
                                                <button 
                                                    onClick={() => handleBlockClick(idx)} 
                                                    className={`w-8 h-8 md:w-14 md:h-14 flex items-center justify-center text-xs md:text-lg font-black rounded-lg border-2 md:border-4 transition-all ${num === null ? 'border-dashed border-zinc-700 bg-transparent text-transparent' : highlightIndices.includes(idx) ? 'bg-white border-white text-black scale-110 z-10' : sortedIndices.includes(idx) ? 'bg-green-500 border-green-300 text-white' : (isBossLevel ? 'bg-zinc-900 border-zinc-700 text-red-700' : 'bg-slate-100 border-slate-200 text-slate-700')}`}
                                                >
                                                    {num}
                                                </button>
                                                <span className="text-[9px] font-mono opacity-30">#{idx}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {algorithm === 'insertion' && (
                                    <div className="flex flex-col items-center gap-3">
                                        <div className="text-[10px] font-black uppercase tracking-widest opacity-40">æš«å­˜æ•¸æ“š (ç·©è¡å€)</div>
                                        <div className={`w-14 h-14 md:w-20 md:h-20 flex items-center justify-center text-2xl md:text-3xl font-black rounded-2xl border-4 transition-all ${tempValue ? (isBossLevel ? 'bg-red-600 border-red-400 text-white shadow-xl shadow-red-600/50 scale-125' : 'bg-orange-500 border-orange-200 text-white scale-125 shadow-xl') : 'bg-zinc-800/10 border-dashed border-zinc-500 text-transparent'}`}>
                                            {tempValue}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="flex gap-4">
                            <button onClick={() => initGame(isBossLevel)} className={`flex-1 py-5 rounded-2xl font-black text-lg transition-all flex items-center justify-center gap-2 ${isBossLevel ? 'bg-zinc-900 text-red-600 hover:bg-zinc-800' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>
                                <Icon name="RefreshCw" /> é‡ç½®æŒ‘æˆ°
                            </button>
                            <button onClick={() => { if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æˆå°±å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }} className="px-6 rounded-2xl bg-zinc-800 text-zinc-500 hover:text-red-400 transition-colors">
                                <Icon name="Trash2" size={18} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
